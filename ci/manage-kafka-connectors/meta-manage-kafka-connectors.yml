meta-manage-kafka-connector:
  plan:
    restart-kafka-connector:
      task: restart-kafka-connector
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: ((docker-awscli.repository))
            version: ((docker-awscli.version))
            tag: ((docker-awscli.version))
        params:
          AWS_DEFAULT_PROFILE: ci
          AWS_SHARED_CREDENTIALS_FILE: .aws/credentials
          AWS_CONFIG_FILE: .aws/config
        run:
          path: sh
          args:
            - -exc
            - |
              TASK_ARN=$(aws --region=eu-west-2 ecs list-tasks --cluster ${ECS_CLUSTER} --service-name ${ECS_SERVICE} | jq -r .taskArns[0])
              aws --region=eu-west-2 ecs stop-task --cluster ${ECS_CLUSTER} --task ${TASK_ARN}
        inputs:
          - name: .aws

    plan:
        scale-kafka-connector:
              task: scale-kafka-connector
              config:
                platform: linux
                image_resource:
                  type: docker-image
                  source:
                    repository: ((docker-awscli.repository))
                    version: ((docker-awscli.version))
                    tag: ((docker-awscli.version))
                params:
                  AWS_DEFAULT_PROFILE: ci
                  AWS_SHARED_CREDENTIALS_FILE: .aws/credentials
                  AWS_CONFIG_FILE: .aws/config
                  DESIRED_COUNT = $(cat ../terraform-output-ingest/outputs.json | jq -r '.k2hb_service.value.max_count')
                run:
                  path: sh
                  args:
                    - -exc
                    - |
                      TASK_ARN=$(aws --region=eu-west-2 ecs update-service --cluster ${ECS_CLUSTER} --service-name ${ECS_SERVICE} --desired-count ${DESIRED_COUNT} | jq -r .taskArns[0])
                      aws --region=eu-west-2 ecs update-service --cluster ${ECS_CLUSTER} --service ${ECS_SERVICE} --desired-count ${DESIRED_COUNT}
                inputs:
                  - name: .aws
